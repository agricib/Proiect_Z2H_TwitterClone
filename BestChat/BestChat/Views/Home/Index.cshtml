@{
    ViewBag.Title = "Home Page";
}

<script src="~/Scripts/jquery-2.1.1.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>


<div style=" margin-left: -10px;text-align:center;">
    <div class="list-group" style=" float: left; margin: 100px auto; width=100">

        <a href="#" class="list-group-item disabled">
            Search
        </a>
        <a href="#" class="list-group-item">

            <button class="btn btn-success" type="button">GO</button>
            <input type="text" class="form-control" placeholder="Search Location">



        </a>
        <a href="#" class="list-group-item">

            <button class="btn btn-warning" type="button" id="buton-SearchUser">GO</button>
            <input type="text" class="form-control" placeholder="Search User" id="input-SearchUser">

        </a>
        <a href="#" class="list-group-item">

            <button class="btn btn-info" type="button">GO</button>
            <input type="text" class="form-control" placeholder="Search Post">


        </a>


    </div>
    <div id="map" style="height: 450px; width: 800px; margin: 100px auto;  display: inline-block;"></div>
    <div class="dropdown" style=" float: right;margin: 100px auto ; width:100px">

        <ul class="list-group" id="list-useri">
            <p id="useri"></p>
        </ul>
    </div>
    <p class="navbar-text navbar-right">Signed in as <a href="#" class="navbar-link">Mark Otto</a></p>
</div>

<script>


    var map;
    function addMarker(user) {
        console.log('Data recived');
        var marker = L.marker([user.Latitude, user.Longitude], { draggable: false });
        marker.addTo(map).bindPopup(user.UserName).openPopup();;
        map.setView([user.Latitude, user.Longitude]);
    }

    $(document).ready(function () {
        map = L.map('map').setView([44.5, 26], 10);
        var layer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
        layer.addTo(map);

        var onClick = function (e) {
            var users = [];
            var bounds = map.getBounds();
            var westt = bounds.getWest();
            var southt = bounds.getSouth();
            var eastt = bounds.getEast();
            var northt = bounds.getNorth();
            $.get("/api/UserPosition", { east: eastt, vest: westt, north: northt, south: southt }).done(function (users) {
                if (users = null) {
                    console.log("Nu am mai primit!");
                }
                else {
                    users.forEach(function (user) {

                        addMarker(user);
                        console.log("am primit" + users);
                    });
                }
            });
            

        }
        map.on('drag', onClick);

    });
    $(document).ready(function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(SendPosition);
        }
        else {
            alert("Geolocation is not supported by this browser.");
        }
        function SendPosition(position) {
            // addMarker(position.coords.latitude, position.coords.longitude);

            $.post("/api/UserPosition", { Latitude: position.coords.latitude, Longitude: position.coords.longitude })
            .done(function (data) {
            });

        }

    });
</script>


<script>
    var showusers = function (users) {
        $('#onlineUsers').empty();
        var div = $('#onlineUsers');
        users.forEach(function (user) {
            if (user.Online === true) {
                console.log(user);
                addMarker(user);
                var time = (new Date).getTime() - user.PositionDate;
                var us = '<li><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal"> ' + user.UserName +'</button></li>';
                $('#list-useri').append(us);


            }
            else {
                var time = (new Date).getTime() - user.PositionDate;
                var us = '<li><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal"> ' + user.UserName + '</button></li>';
                $('#list-useri').append(us);
            }
        });

    };


    var onlineusers = [];
    $.get("/api/User").done(function (users) {
        onlineusers = users;
        showusers(users);

    });

    $("#buton-SearchUser").on("click", function () {
        var username = $("#input-SearchUser").val();
        var findedusers = [];
        onlineusers.forEach(function (user) {
            if (user.UserName.indexOf(username) > -1) {
                findedusers.push(user);
            }

        });
        showusers(findedusers);
    });
</script>