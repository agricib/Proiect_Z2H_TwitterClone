@{
    ViewBag.Title = "Home Page";
}

<script src="~/Scripts/jquery-2.1.1.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>


<div class="container" style="width: 100%; margin: 50px auto; ">
    <div class="row" style="width:100%;">
        <div class="col-md-3">
            <div class="list-group input-group-sm">

                <a href="#" class="list-group-item disabled">
                    Search
                </a>
                <a href="#" class="list-group-item">

                    <button class="btn btn-success" type="button">GO</button>
                    <input type="text" class="form-control" placeholder="Search Location">

                </a>
                <a href="#" class="list-group-item">

                    <button class="btn btn-warning" type="button" id="buton-SearchUser">GO</button>
                    <input type="text" class="form-control" placeholder="Search User" id="input-SearchUser">

                </a>
                <a href="#" class="list-group-item">

                    <button class="btn btn-info" type="button">GO</button>
                    <input type="text" class="form-control" placeholder="Search Post">
                </a>
            </div>
        </div>
        <div class="col-md-7" id="map" style="height:450px"></div>
        <div class="col-md-2">

            <ul class="list-group">
                <li class="list-group-item" id="list-useri" style="list-style:none;"></li>
            </ul>
        </div>
    </div>
</div>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">New message</h4>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Recipient:</label>
                        <input type="text" class="form-control" id="recipient-name">
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="control-label">Message:</label>
                        <textarea class="form-control" id="message-text"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Send message</button>
            </div>
        </div>
    </div>
</div>






<script>

    var markers = new Array();
    var map;
    var onlineusers = [];
    var greenIcon = L.icon({
        iconUrl: '/img/marker-icon-red.png',
        

        iconSize: [25, 40], // size of the icon
        shadowSize: [50, 64], // size of the shadow
        iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
    });
    function addMarker(user,OnOff) {
        console.log('Data recived');
        if (OnOff) {
            var marker = L.marker([user.Latitude, user.Longitude], { draggable: false});
        }
        else {
            var marker = L.marker([user.Latitude, user.Longitude], { draggable: false, icon: greenIcon });
        }
        markers.push(marker);
        marker.addTo(map).bindPopup(user.UserName);

    }

    $(document).ready(function () {
        map = L.map('map').setView([44.5, 26], 10);
        var layer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
        layer.addTo(map);

        var onClick = function (e) {

            for (var i = 0; i < markers.length; i++) {
                map.removeLayer(markers[i]);
            }

            var users = [];
            var bounds = map.getBounds();
            var west = bounds.getWest();
            var south = bounds.getSouth();
            var east = bounds.getEast();
            var north = bounds.getNorth();

            onlineusers = [];
            $.get("/api/UserPosition", { east: east, west: west, north: north, south: south }).done(function (users) {
                onlineusers = users;
                showusers(users);
                

            });


        }
        map.on('dragend', onClick);
        map.on('zoomend', onClick);
        map.on('viewreset', onClick);

    });
    $(document).ready(function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(SendPosition);
        }
        else {
            alert("Geolocation is not supported by this browser.");
        }
        function SendPosition(position) {


            $.post("/api/UserPosition", { Latitude: position.coords.latitude, Longitude: position.coords.longitude })
            .done(function (data) {
            });

        }

    });
</script>


<script>
    var moveuser = function (users) {
        $('#onlineUsers').empty();

        users.forEach(function (user) {

            map.setView([user.Latitude, user.Longitude], 13);


        });

    };
    var showusers = function (users) {

        $('#list-useri').empty();
        var div = $('#list-useri');
        users.forEach(function (user) {
            if (user.Online === true) {
                console.log(user);
                addMarker(user,true);
                var time = (new Date).getTime() - user.PositionDate;
                var use = '<li><button type="button" class="btn btn-group-vertical" data-toggle="modal" data-target="#exampleModal" style="width:150px;border: 1px solid #999;"> '
                    + user.UserName + '</button></li>';
                $('#list-useri').append(use);


            }
            else {
                addMarker(user, false);
                var time = (new Date).getTime() - user.PositionDate;
                var us = '<li><button type="button" class="btn btn-group-vertical btn-danger" data-toggle="modal" data-target="#exampleModal" style="width:150px;border: 1px solid #999;"> '
                    + user.UserName + '</button></li>';
                $('#list-useri').append(us);
            }
        });

    };




    $("#buton-SearchUser").on("click", function () {
        var username = $("#input-SearchUser").val();
        var findedusers = [];
        onlineusers.forEach(function (user) {
            if (user.UserName.indexOf(username) > -1) {
                findedusers.push(user);
            }

        });
        moveuser(findedusers);
    });
</script>