@{
    ViewBag.Title = "Home Page";
}

@*<script src="~/Scripts/jquery-2.1.1.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>*@
<script src="~/Scripts/jquery.signalR-2.1.2.min.js"></script>
<script src="~/signalr/hubs"></script>

<div class="container" style="width: 100%; margin: 50px auto; ">
    <div class="row" style="width:100%;">
        <div class="col-md-3">

         
            <div class="list-group input-group-sm">
                          
                <a href="#" class="list-group-item">

                    <button class="btn btn-info" type="button" id="buton-SearchUser">GO</button>
                    <input type="text" class="form-control" placeholder="Search User" id="input-SearchUser">

                </a>
               
                </div>
            
                <div class="panel panel-info">
                    <div class="panel-heading">
                        RECENT CHAT HISTORY
                    </div>
                    <div class="panel-body">
                    <ul class="nav nav-tabs small" id="tabs"></ul>
                    <ul class="media-list" id="chatMess"></ul>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Enter Message">
                                <span class="input-group-btn">
                                    <button class="btn btn-info" type="button">SEND</button>
                                </span>
            </div>
        </div>
                    </div>
                </div>
            </div>
      
        <div class="col-md-7" id="map" style="height:450px"></div>
        <div class="col-md-2">
            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                <div class="panel-heading  " typeof="" role="tab" id="headingOne">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            <button class="btn btn-info" style="width:100%"><p style="font-size:16px">My Users</p></button>
                        </a>
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse active" role="tabpanel" aria-labelledby="headingOne">
                        <div class="list-group">
                            <ul class="list-group">
                                <li class="list-group-item" id="list-useri" style="list-style:none;"></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @*<div class="container">
            <ul id="discussion"></ul>
        </div>*@
    </div>








        <script>
            $('#myButton').on('click', function () {
                var $btn = $(this).button('loading')
                // business logic...
                $btn.button('reset')
            })
        </script>

        <script>
            var chat = $.connection.chatHub;
            var markers = new Array();
            var map;
            var onlineusers = [];
            var greenIcon = L.icon({
                iconUrl: '/img/marker-icon-red.png',


                iconSize: [25, 40], // size of the icon
                shadowSize: [50, 64], // size of the shadow
                iconAnchor: [20, 20], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62],  // the same for the shadow
                popupAnchor: [0, -20] // point from which the popup should open relative to the iconAnchor
            });
            function addMarker(user, OnOff) {
                console.log('Data recived');
                if (OnOff) {
                    var marker = L.marker([user.Latitude, user.Longitude], { draggable: false });
                }
                else {
                    var marker = L.marker([user.Latitude, user.Longitude], { draggable: false, icon: greenIcon });
                }
                markers.push(marker);
                marker.addTo(map).bindPopup(user.UserName);

            }

            $(document).ready(function () {
                map = L.map('map').setView([44.5, 26], 10);
                var layer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
                layer.addTo(map);

                var showMarkerOnMap = function (e) {

                    for (var i = 0; i < markers.length; i++) {
                        map.removeLayer(markers[i]);
                    }

                    var users = [];
                    var bounds = map.getBounds();
                    var west = bounds.getWest();
                    var south = bounds.getSouth();
                    var east = bounds.getEast();
                    var north = bounds.getNorth();

                    onlineusers = [];
                    $.get("/api/UserPosition", { east: east, west: west, north: north, south: south }).done(function (users) {
                        onlineusers = users;
                        showusers(users);


                    });


                }

                map.on('dragend', showMarkerOnMap);
                map.on('zoomend', showMarkerOnMap);
                map.on('viewreset', showMarkerOnMap);
                showMarkerOnMap();

            });
            $(document).ready(function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(SendPosition);
                }
                else {
                    alert("Geolocation is not supported by this browser.");
                }
                function SendPosition(position) {


                    $.post("/api/UserPosition", { Latitude: position.coords.latitude, Longitude: position.coords.longitude })
                    .done(function (data) {
                    });

                }

            });




            var moveuser = function (users) {
                $('#onlineUsers').empty();

                users.forEach(function (user) {

                    map.setView([user.Latitude, user.Longitude], 13);


                });

            };
            var showusers = function (users) {

                $('#list-useri').empty();
                var div = $('#list-useri');
                users.forEach(function (user) {
                    if (user.Online === true) {
                        console.log(user);
                        addMarker(user, true);
                        var time = (new Date).getTime() - user.PositionDate;
                var use = '<li><button type="button" class="btn btn-group-vertical btnuser" onClick="showChat(\'' + user.UserName + '\')" style="width:150px;border: 1px solid #999;"> '
                            + user.UserName + '</button></li>';
                        $('#list-useri').append(use);


                    }
                    else {
                        addMarker(user, false);
                        var time = (new Date).getTime() - user.PositionDate;
                        var us = '<li><button type="button" class="btn btn-group-vertical btn-danger" data-toggle="modal"  style="width:150px;border: 1px solid #999;"> '
                            + user.UserName + '</button></li>';
                        $('#list-useri').append(us);
                    }
                });

            };

    $("#buton-SearchUser").on("click", function searchUser() {
                var username = $("#input-SearchUser").val();
                var findedusers = [];
        onlineusers.forEach(function (user) {
                    if (user.UserName.indexOf(username) > -1) {
                        findedusers.push(user);
                    }

                });

                moveuser(findedusers);
        $("#input-SearchUser").val('');

            });




    var showChat =function (user) {
        var tab = '<li role="presentation" class="active"><a href="#">' + user + '</a></li>';
        var chats = '<li class="media"><div class="media-body"><div class="media"><a class="pull-left" href="#"></a><div class="media-body"></div> </div></div></li>'
        $('#tabs').append(tab);
        $('#chatMess').append(chats);
    };



            $(function () {

                var chat = $.connection.chatHub;
                chat.client.addNewMessageToPage = function (message) {

                    $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong> ' + htmlEncode(message) + '</li>');
                };

                $('#message-text').focus();

                $.connection.hub.start().done(function () {
                    $('#myButton').click(function () {

                        chat.server.send($('#recipient-name').val(), $('#message-text').val());
                        $('#discussion').append('<li><strong>Me</strong>' + htmlEncode($('#message-text').val()) + '</li>');

                        $('#message-text').val('').focus();
                    });
                });
            });
            function htmlEncode(value) {
                        var encodedValue = $('<div />').text(value).html();
                        return encodedValue;
                    }

        </script>

